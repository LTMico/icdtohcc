# ICD to HCC

### Generate Medicare Hierchical Condition Categories (HCC) based on ICD codes

### Introduction
- many to many relationship
- ICD9/10 are mapped to Condition Categories (CC), and a hierarchy based on disease severity is applied to the CCs to generate HCCs. 

### Data
The ICD/HCC mappings were obtained from [CMS](https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors.html). CMS provides SAS macros for assigning HCCs and HCC scores based on ICDs, adjusted annually. We have implemented assigning HCCs (but not scores) in R. The original data is available from CMS, or in the github repository at /crosswalks/originalCMS_xw.

Between 2007-2012, there were 70 HCCs (Version 12). In 2013, this was expanded to 87 (Version 20). We use the labels for the more inclusive mappings (post-2013) for all years for consistency. This means that in pre-2013 data 17 HCCs will be structurally zero. 
### Packages
```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, cache=F)
```

```{r}
library(lubridate)
library(stringr)
library(dplyr)
library(tidyr)
```

### Import ICD9 - CC crosswalks
These are the files in the crosswalk folders. This naming convention allows use of the year from filenames in organizing the data later.

```{r}
# ICD-9
list.files("crosswalks/importable_xw/icd9/")

# ICD-10
list.files("crosswalks/importable_xw/icd10/")
```

Import the ICD9 and ICD10 HCC crosswalks, one per year, into a list of dataframes
```{r} 
icd9cc <- apply(data.frame(paste("crosswalks/importable_xw/icd9/",list.files("crosswalks/importable_xw/icd9/"),sep="")), 1, FUN=read.fwf, width=c(7,4), header=F, stringsAsFactors=F)

icd10cc <- apply(data.frame(paste("crosswalks/importable_xw/icd10/",list.files("crosswalks/importable_xw/icd10/"),sep="")), 1, FUN=read.fwf, width=c(7,4), header=F, stringsAsFactors=F)

# Create a vector of year names based on the file names in the icd folders
years <- list()
years$icd9 <- as.numeric(substr(list.files("crosswalks/importable_xw/icd9/"), 0,4))
years$icd10 <- as.numeric(substr(list.files("crosswalks/importable_xw/icd10/"), 0,4))

# assign year to each dataframe within the list of dataframes
icd9cc <- mapply(cbind, icd9cc, "year" = years$icd9, SIMPLIFY=F)
icd10cc <- mapply(cbind, icd10cc, "year" = years$icd10, SIMPLIFY=F)

# Row bind icd9 and icd10 from different years into despective dataframes
icd9cc <- rbind_all(icd9cc)
icd10cc <- rbind_all(icd10cc)

# Assign ICD version (9 or 10) and combine into single dataframe
icd9cc$icdversion <- 9
icd10cc$icdversion <- 10
icdcc <- rbind(icd9cc, icd10cc)

rm(icd9cc, icd10cc, years)

# add variable names
colnames(icdcc) <- c("icd", "cc", "year", "icdversion")

# Remove whitespace from codes
icdcc$icd <- str_trim(icdcc$icd)
icdcc$cc <- str_trim(icdcc$cc)
```

```{r}
head(icdcc)
```

### Edit ICD9/10s
Per CMS instructions, certain ICD9s have to be manually assigned additional CCs
```{r}
# icd9 40403, 40413, and 40493 are assigned to CC 80 in 2007-2012
extracodes <- list()
extracodes$e1 <- c("40403", "40413", "40493")
extracodes$e1 <- expand.grid(extracodes$e1, "80", 2007:2012, 9, stringsAsFactors = F)

# icd9 40401, 40403, 40411, 40413, 40491, 40493 are assigned to CC85 in 2013
extracodes$e2 <- c("40401","40403","40411","40413","40491","40493")
extracodes$e2 <- expand.grid(extracodes$e2, "85", 2013, 9, stringsAsFactors = F)

# icd9 40403, 40413, 40493 are assigned to CC85 in 2014-2015
extracodes$e3 <- c("40403","40413","40493")
extracodes$e3 <- expand.grid(extracodes$e3, "85", 2014:2015, 9, stringsAsFactors = F)

# icd9 3572 and 36202 are assigned to CC18 in 2013
extracodes$e4 <- c("3572", "36202")
extracodes$e4 <- expand.grid(extracodes$e4, "18", 2013, 9, stringsAsFactors = F)

# icd9 36202 is assigned to CC18 in 2014-2015
extracodes$e5 <- "36202"
extracodes$e5 <- expand.grid(extracodes$e5, "18", 2014:2015, 9, stringsAsFactors = F)

# combine into one DF
extracodes <- rbind_all(extracodes)

# add variable names
colnames(extracodes) <- c("icd", "cc", "year", "icdversion")

# combine with full icdcc listing
icdcc <- rbind(icdcc, extracodes)
rm(extracodes)
```

### Import Labels
```{r}
# Import most inclusive HCC labels (2013)
labels <- readLines("crosswalks/importable_xw/labels/V20H87L1.TXT")

# Extract HCC numbers
hccnum <- str_match(labels, "HCC([:digit:]*)")[,2]

# Extract HCC names
hccname <- str_match(labels, "(\")([:print:]*)(\")")[,3]

# Combine numbers and names into dataframe of labels
labels <- as.data.frame(cbind(hccnum, hccname))
labels <- labels[!is.na(labels$hccname),]
rm(hccnum, hccname)
```

### Define Hierarchy
```{r}
# import raw hierarchy files from CMS
hierarchy <- apply(data.frame(paste("crosswalks/importable_xw/hierarchy/",list.files("crosswalks/importable_xw/hierarchy/"),sep="")), 1, FUN=readLines)

# Create a vector of year names based on the file names in the icd folders
years <- as.numeric(substr(list.files("crosswalks/importable_xw/hierarchy/"), 0,4))

# Add year variable to each dataframe
hierarchy <- mapply(cbind, hierarchy, "year" = years, SIMPLIFY=F)

# convert each item in the list of hierarchy objects into a data.frame and combine into a single DF
hierarchy <- lapply(hierarchy, as.data.frame, stringsAsFactor=F)
hierarchy <- rbind_all(hierarchy)

# only keep the lines that are logical hierarchy statements (removes comments, empty lines, additional code) and rename variable
hierarchy <- hierarchy[grepl("if hcc|%SET0", hierarchy$V1),]
colnames(hierarchy)[1] <- "condition"

# Extract the HCC that is used in the if condition statement
hierarchy$ifhcc <- str_extract(hierarchy$condition, "(?<=hcc)([0-9]*)|(?<=CC\\=)([0-9]*)")

# Extract the HCCs that should be set to zero if the above condition is met
tozero <- str_extract(hierarchy$condition, 
                 "(?<=i\\=)([:print:]*)(?=;hcc)|(?<=STR\\()([:print:]*)(?= \\)\\);)")

# convert it to a dataframe and bind it with the original hierarchy data
tozero <- as.data.frame(str_split_fixed(tozero, ",", n=8), stringsAsFactors = F)
# convert to numeric
tozero <- as.data.frame(lapply(tozero, as.numeric))

# combine CC requirements with CCs to zero
hierarchy <- cbind(hierarchy[,c("year", "ifhcc")], tozero)
rm(tozero)
```

### Apply CCs
Will apply this hierarchy to sample (random) patient data in wide format, with up to 25 diagnoses per patient
```{r}
# Import sample data
pt <- readRDS("data/sampleptdata.rds")

# convert all fields to characters (no factors)
pt <- data.frame(lapply(pt, as.character), stringsAsFactors = F)

# convert to long format
pt <- pt %>%
  gather(diag, icd, -id, -admtdate, na.rm=T) %>%
  select(-diag)

# Convert date to posix
pt$admtdate <- parse_date_time(pt$admtdate, orders="Ymd")

# Add year column
pt$year <- year(pt$admtdate)

# add column for ICD (all data in this example are ICD9)
pt$icdversion <- 9

# merge CCs to patient data based on ICD/year/version, and drop ICD info
pt <- pt %>%
  left_join(icdcc) %>%
  select(-icd, -icdversion)
```


### References
- https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors.html
- https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Reports/downloads/pope_2000_2.pdf