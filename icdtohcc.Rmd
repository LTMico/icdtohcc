# ICD to HCC

### Generate Medicare Hierchical Condition Categories (HCC) based on ICD codes

### Introduction
- many to many relationship
- ICD9/10 are mapped to Condition Categories (CC), and a hierarchy based on disease severity is applied to the CCs to generate HCCs. 

### Data
The ICD/HCC mappings were obtained from [CMS](https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors.html). CMS provides SAS macros for assigning HCCs and HCC scores based on ICDs, adjusted annually. We have implemented assigning HCCs (but not scores) in R. The original data is available from CMS, or in the github repository at /crosswalks/originalCMS_xw.

Between 2007-2012, there were 70 HCCs (Version 12). In 2013, this was expanded to 87 (Version 20). We use the labels for the more inclusive mappings (post-2013) for all years for consistency. This means that in pre-2013 data 17 HCCs will be structurally zero. 
### Packages
```{r}
library(stringr)
library(dplyr)
```

### Import ICD9 - HCC crosswalks
These are the files in the crosswalk folders. This naming convention allows use of the year from filenames in organizing the data later.

```{r}
# ICD-9
list.files("crosswalks/importable_xw/icd9/")

# ICD-10
list.files("crosswalks/importable_xw/icd10/")
```

Import the ICD9 and ICD10 HCC crosswalks, one per year, into a list of dataframes
```{r} 
icd9hcc <- apply(data.frame(paste("crosswalks/importable_xw/icd9/",list.files("crosswalks/importable_xw/icd9/"),sep="")), 1, FUN=read.fwf, width=c(7,4), header=F, stringsAsFactors=F)

icd10hcc <- apply(data.frame(paste("crosswalks/importable_xw/icd10/",list.files("crosswalks/importable_xw/icd10/"),sep="")), 1, FUN=read.fwf, width=c(7,4), header=F, stringsAsFactors=F)

# Create a vector of year names based on the file names in the icd folders
years <- list()
years$icd9 <- as.numeric(substr(list.files("crosswalks/importable_xw/icd9/"), 0,4))
years$icd10 <- as.numeric(substr(list.files("crosswalks/importable_xw/icd10/"), 0,4))

# assign year to each dataframe within the list of dataframes
icd9hcc <- mapply(cbind, icd9hcc, "year" = years$icd9, SIMPLIFY=F)
icd10hcc <- mapply(cbind, icd10hcc, "year" = years$icd10, SIMPLIFY=F)

# Row bind icd9 and icd10 from different years into despective dataframes
icd9hcc <- rbind_all(icd9hcc)
icd10hcc <- rbind_all(icd10hcc)

# Assign ICD version (9 or 10) and combine into single dataframe
icd9hcc$icdversion <- 9
icd10hcc$icdversion <- 10
icdhcc <- rbind(icd9hcc, icd10hcc)

rm(icd9hcc, icd10hcc, years)

# add variable names
colnames(icdhcc) <- c("icd", "hcc", "year", "icdversion")

# Remove whitespace from codes
icdhcc$icd <- str_trim(icdhcc$icd)
icdhcc$hcc <- str_trim(icdhcc$hcc)
```

```{r}
head(icdhcc)
```

### Need to manually enter certain additional ICD9/10s
```{r}
# icd9 40403, 40413, and 40493 are assigned to CC 80 in 2007-2012
extracodes <- list()
extracodes$e1 <- c("40403", "40413", "40493")
extracodes$e1 <- expand.grid(extracodes$e1, "80", 2007:2012, 9, stringsAsFactors = F)

# icd9 40401, 40403, 40411, 40413, 40491, 40493 are assigned to CC85 in 2013
extracodes$e2 <- c("40401","40403","40411","40413","40491","40493")
extracodes$e2 <- expand.grid(extracodes$e2, "85", 2013, 9, stringsAsFactors = F)

# icd9 40403, 40413, 40493 are assigned to CC85 in 2014-2015
extracodes$e3 <- c("40403","40413","40493")
extracodes$e3 <- expand.grid(extracodes$e3, "85", 2014:2015, 9, stringsAsFactors = F)

# icd9 3572 and 36202 are assigned to CC18 in 2013
extracodes$e4 <- c("3572", "36202")
extracodes$e4 <- expand.grid(extracodes$e4, "18", 2013, 9, stringsAsFactors = F)

# icd9 36202 is assigned to CC18 in 2014-2015
extracodes$e5 <- "36202"
extracodes$e5 <- expand.grid(extracodes$e5, "18", 2014:2015, 9, stringsAsFactors = F)

# combine into one DF
extracodes <- rbind_all(extracodes)

# add variable names
colnames(extracodes) <- c("icd", "hcc", "year", "icdversion")

# combine with full icdhcc listing
icdhcc <- rbind(icdhcc, extracodes)
rm(extracodes)
```

### Import Labels
```{r}
# Import most inclusive HCC labels (2013)
labels <- readLines("crosswalks/importable_xw/labels/V20H87L1.TXT")

# Extract HCC numbers
hccnum <- str_match(labels, "HCC([:digit:]*)")[,2]

# Extract HCC names
hccname <- str_match(labels, "(\")([:print:]*)(\")")[,3]

# Combine numbers and names into dataframe of labels
labels <- as.data.frame(cbind(hccnum, hccname))
labels <- labels[!is.na(labels$hccname),]
rm(hccnum, hccname)
```

### Hierarchy
```{r}


```


### References
- https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors.html
- https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Reports/downloads/pope_2000_2.pdf